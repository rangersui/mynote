[toc]

# VPN概述

虚拟专用网virtual private network, 物理上分布在不同地点的网络通过公用网络连接形成逻辑上的虚拟专网。

## 特点

- 费用低
- 安全保障
- 服务质量保证QoS
- 可扩充性和灵活性
- 可管理性

## 分类

- 网关-网关VPN
  - VPN网关 --VPN隧道-->公共网络--VPN连接-->VPN网关 
- 远程访问VPN
  - VPN网关 --VPN隧道-->公共网络--VPN连接-->VPN客户端

## 关键技术

- 隧道技术
- 加解密
- 密钥管理
- 身份认证
- 访问控制

# 隧道协议

指通过一个公用网络（通常是Internet）建立的一条穿过公用网络的安全的、逻辑上的隧道。在隧道中，数据包被重新封装发送。

## 主要协议

第2层的隧道协议

- 包括PPTP、L2TP、L2F等；

第3层的隧道协议

- 包括IPSec、GRE等。

# IPSec VPN

- 类似包过滤防火墙
- 查询安全策略数据库SPD决定对收到的IP数据包转发、丢弃或IPSec处理
- 可以对IP数据包只进行加密/认证也可以同时实施。（AH/ESP/AH+ESP）
- 两种工作模式：传输（主机到主机的通信）和隧道（其它任何方式）
- 两种封装：AH（认证头标）,ESP（封装安全净载）

| **功能**/**模式** | **认证头协议**（**AH**） | **封装安全载荷（**ESP**）** | **ESP+AH** |
| ----------------- | ------------------------ | --------------------------- | ---------- |
| **访问控制**      | **Yes**                  | **Yes**                     | **Yes**    |
| **认证**          | **Yes**                  | **—**                       | **Yes**    |
| **消息完整性**    | **Yes**                  | **—**                       | **Yes**    |
| **重放保护**      | **Yes**                  | **Yes**                     | **Yes**    |
| **机密性**        | **—**                    | **Yes**                     | **Yes**    |

- IKE（Internet Key Exchange）动态建立安全关联SA（Security Association）
  - 建立IKE安全关联，通信双方之间协商密钥；
  - 利用既定得安全关联为IPSec建立安全通道；
  - SA由：安全性参数索引SPI、IP目的地址、安全协议标识组成

## SA

SA决定网络上两个实体之间通信的安全特征。

一个SA只能使用AH或ESP之一，不能同时使用AH和ESP。

安全关联是单向的，如果需要互相进行安全通信，需要两个安全关联。

### 组成

安全参数索引：分配给SA的32位标识符，位置在AH和ESP首部，作用是使接收实体在收到数据时能确定在那个SA下处理。

目的IP：SA中接收实体的IP地址，该地址可以是终端用户地址，也可以是防火墙或安全网关等网络设备地址

安全协议标识符：说明使用AH/ESP协议。

# SSL/TLS VPN

## 概述

SSL（Security Socket Layer） VPN也称作传输层安全协议TLS（Transport Layer Security） VPN。

TLS协议主要用于HTTPS协议中，也可以作为构造VPN的技术

不需要安装和配置客户端

## 协议建立

- Client hello
- Server hello
- 服务器证书
- 证书请求（请求客户端）
- Server hello完成
- 客户端证书
- （客户端）证书验证
- （客户端）密钥交换协议
- （客户端）完成
- （服务器）密钥交换协议
- （服务器）完成
- （服务器）数据传输

### 密钥交换协议

产生主密钥->主密钥产生会话密钥（A->B和B->A）->主密钥产生两个消息认证码密钥

## 实现方式

在防火墙后放置一个TLS代理服务器

### 三种协议

#### 握手协议