[toc]

# 数据链路层的基本概念

## 术语

链路：一条无源的点到点的物理线路段，中间没有任何其他的交换节点

数据链路：除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路

帧：在数据链路层之间传输的数据单位是帧。

## 数据链路层的主要功能

向网络层提供**可靠的、透明的**数据传输服务，将源节点的网络层数据可靠地传送到相邻节点的网络层

- 链路管理

  数据链路的建立、维持和释放：两结点通信前要交换一些信息，称为建立数据连接，然后传输数据

- 封装成帧

  数据链路层，数据的传送以帧为单位：界定帧（帧同步）是指接收方能从收到的比特流中区分一个帧的开始和结束的地方

- 流量控制

  发送方发送数据的速率必须使接收方能来得及接收

- 差错控制

  纠错：通过编码技术，接收方自动将差错改正过来

  纠错：检测出帧有错误，要么忽略或重传

- 将数据和控制信息区分开

  数据和控制信息在同一个帧中，收方将其区分开

- 透明传输

  不管所传数据的比特组合，都能在链路上传送；

  若所传的数据的比特片段与某一个控制信息相同，要有可靠机制，保证收方能正确识别

- 寻址

  每一帧都能送到正确的目的地；

  收方也能知道发送方的地址

# 组帧

组帧（framing）就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。

目的：让接收方能够准确识别帧的边界

首部和尾部的一个重要作用就是进行帧定界

## 帧定界（帧同步）的方法

### 字节计数法

#### 思想

在帧头设置一个长度域，放置该帧的字节数；收方收到帧后，通过帧的长度，确定帧的开始。

#### 问题

当帧长度域出错，帧同步完全丢失；该方法很少单独使用

### 使用字符填充的首尾定界法

#### 思想

使用特殊的ASCII字符（不可打印的控制字符）作为帧的起始和终止定界符。例如SOH作为开始符，EOT作为结束符。

#### 问题：数据传输不透明

当数据出现定界符SOH或EOT时，如何加以区分时数据还是定界符？

#### 解决

发送端的数据链路层在数据中出现控制字符的前面加一个转义符。接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。

缺点：使用字符来控制帧的传输，数据传输的单位是字符（8bit的ASCII），帧长度时8的倍数；传输任意长度的二进制比特带来不便；

### 使用比特填充的首尾定界法*

#### 思想

使用一个特殊的比特模式01111110作为帧的起始和结束标志。

发送方：边发送边检查数据，没连续发送5个1后在后面自动插入一个0，这样数据中只会连续出现5个1而不会有定界符。

接收方：再收到5个连续的1后将后面的0删掉而会恢复出原始数据。

#### 好处

数据传输的基本单位是比特而不是字符，可用来传输任意长度的二进制比特串，通用性强。

### 违法编码法

#### 前提

物理介质上使用的信号编码有冗余码字时，使用这些荣荣誉的码字作为帧的定界。

#### 举例

如曼彻斯特编码或差分曼彻斯特编码中，有效电平是“低-高”或“高-低”，而“低-低”和“高-高”没有定义，这种违法编码可以作为帧边界。

# 差错控制

## 差错控制技术

### 前向纠错FEC

- 即发送方发送能使接收方检错并纠错的冗余位，纠错任务由接收方完成；常采用海明码。
- 主要应用于没有反向信道或反向传输时间很长的场合

#### 缺点

为纠错附加的冗余码较多，传输效率低

#### 优点

实时性好

### 自动重发请求ARQ

即发送方发送能使接收方**检错**的冗余位，若无差错，则接收方回送一个肯定应答ACK；若有差错，则接收方回送一个否定应答NAK，要求发送方重发。

#### 缺点

信息传递连贯性差

#### 优点

接收端设备简单，只要请求重发，无需纠正错误。

## 差错编码技术

### 差错编码

数据块中插入冗余信息的过程。

思想：判断一个数据块中是否存在传输错误，发送端必须在数据块中插入一些冗余信息，使得数据块中的各个比特建立某种形式的关联，接收端通过验证这种关联关系来判断是否有传输错误。

#### 策略

检错码：能检测出错误，但不能纠正错误，如CRC

纠错码：能知道错误，且知道错误的位置，如海明码

### 检错码（奇偶校验，CRC）

#### 构造

- 检错码（码字、传输帧）=信息位+冗余校验位
- 码字长：n=K（信息位位数）+r（校验位位数）
- 编码效率：R=有效数据位K/码字长n

#### 信息字段和校验字段之间的对应关系

- 校验字段越长，编码的检错能力越强，编码/解码越复杂；附加的冗余信息在整个编码中所占的比例越大，传输的有效成分越低，传输的效率下降。
- 检错码一旦形成，整个检错码将作为一个整体被发往线路，通常的发送顺序使信息字段在前，校验字段在后。

#### 奇偶校验

奇校验：使码字中“1”的总个数为奇数，包括信息位和校验位

偶校验：使码字中“1”的总个数为偶数

奇/偶校验码：最常用的一种检错码，包括

- 水平奇/偶校验码

  其信息字段以字符为单位，校验字段仅含一个比特称为校验比特或校验位。

  例如：使用七单位的ASCII码来构造成八单位的检错码时若采用奇偶校验，校验位的取值应使整个码字包括校验位，1的比特个数为奇数或偶数

  编码效率：Q/(Q+1)

  应用：异步传输用偶校验，同步传输用奇校验

- 垂直奇/偶校验码

  对信息按行、列分组，然后对列进行奇偶校验

  被传输的信息进行分组，并排列为若干行和若干列。组中每行的相同列进行奇/偶校验，最终产生由校验位形成的校验字符（校验行），并附加在信息分组之后传输

  举例：四个ASCII字符（四行）组成一信息组，求垂直奇偶校验码，存在最后一行

  编码效率：PQ/P(Q+1)假设信息分组Q行P列

- 水平垂直奇/偶校验码

  水平校验的基础上进行垂直校验，就是每一行后面都有一个奇偶校验位

  编码效率：PQ/(P+1)(Q+1)假设信息分组为Q行P列

#### 循环冗余码CRC

计算机和数据通信中使用的最广泛的检错码，漏检率低，可用简单的电路实现。

给定一个k比特的帧或比特，发送方生成n比特的序列（也称帧检测序列FCS），形成（k+n）的码字，该码字能被某个事先确定的数整除。接收方用相同的数去除收到的帧，如果无余数，则认为数据帧无差错。

任意一个由二进制位串组成的代码都可以和一个系数仅为'0'和'1'取值的多项式一一对应。

多项式表示：即将k比特的数据用k项对象是表示，它的各项为X^(k-1)^...x^0^，它的系数为数据中对应位的0或1.

例如：1010111对应x^6^+x^4^+x^2^+x+1

多项式位x^5^+x^3^+x^2^+x+1对应101111

##### CRC计算

假设待传数据为1010001101 k bit。我们在M的后面再添加供差错检测用的n bit冗余码一起发送。

计算方法：

用二进制的模2运算进行2^n^乘m的运算，这相当于再M后面添加n个0.

得到的(k+n)bit的数除以事先选定好的长度为(n+1)bit的数P，得出商是Q而余数是R，余数R比除数P少1个比特。

核心问题：P如何选定？P若选定则n就确定了。

发送方和接收方**事先约定**生成多项式

- 生成多项式的最高位和最低为都必须为1

生成多项式P的用处

- 发送方用它生成冗余位；用P生成R
- 接收方用它判断是否有错

实现

- 不同的P有不同的编码电路，用简单的移位寄存器电路硬件实现
- 发送方通过编码电路产生冗余位，接收方用相似电路检测错误

若P为r阶（r+1）位比特，生成r位冗余位

##### 发送方用P生成冗余位

- P(x) 生成多项式

- M(x) 信息多项式

- R(x) 冗余多项式

- T(x) 传输帧多项式

- 发送方用P(x)产生冗余位

  2^n^*M(x)/P(x)产生冗余多项式R(x)附加到M(x)后形成T(x)变成带校验位的传输帧多项式

##### 接收方用P进行校验

- T(x)/P(x)

  除不尽有错，除得尽无措或漏检

- 有错分析

  只要得出的余数R不为0，就表示检测到了差错。即用收到的比特流（2^n^M+R）除以P，看得出的余数是否为0.

  但这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错。

  一旦检测出差错，就丢弃这个出现差错的帧。

##### 接收方用P进行校验（漏检）

收到：T(x)+E(x)；其中E(x)为出错多项式

漏检，即[T(x)+E(x)]/P(x)=0

因为T(x)/P(x)=0

所以E(x)/P(x)=0

即若P(x)是E(x)的因子，将可能漏检

选取合适的P(x)，使P(x)不成为E(x)的银子，则可避免漏检

CRC不保证检测出所有的传输错误，要选择位数足够的P，可以使得差错概率足够小

例如：CRC-16和CRC-CCITT可以检测出所有1、2、奇数个、突发长度小于等于16比特错。17比特突发错的99.997%，18比特或更长比特突发错的99.998%

### 纠错码

#### 汉明码

汉明码是信道编码，通过插入冗余信息，使得在有差错的信道中实现无差错的传输

##### 码距（Hamming Distance）

一个编码系统中任意两个合法编码（码字）之间不同的二进位数叫这两个码字的码距。

例如10001001与10110001的码距为3

整个编码系统两个码字的最小距离就是该系统的码距

##### 结论

- 如果要检测出d比特的错，编码集的汉明码距至少为d+1
- 如果要纠正d比特的错，则编码集的汉明距离至少应该为2d+1

例如4个有效码字：它们是000000，000111，111000，111111，汉明距离为3，能纠正1比特错

##### 基本思想

k比特信息后附加r比特冗余信息（校验比特），构成n=k+r比特的码字，其中每个校验比特和某几个特定的信息比特构成偶校验关系。

接收端对r个奇偶校验关系进行校验，即将每个校验比特与关联的信息进行相加（异或），相加结果为校正因子。

- 如果没有错，则r个校正因子都为0
- 若校正因子不全为0，根据校正因子取值，确定错误发生的位置

##### 发送方冗余计算

根据信息位长度（如每帧k位），计算出所需冗余位位数r：

- 纠正一位错，满足2^r^ ≥ k+r+1
- 原理：求汉明码时的一项基本考虑时确定所需最少的校验位数r。考虑长度为k位的信息，若附加了r个校验位，则所发送的总长度位K+r。在接收端中要进行r个奇偶检查，每个检查结果或是真或是伪。这个奇偶检查的结果可以表示成一个r位的二进制数，它可以确定最多2^r^种不同状态。这些状态中必有一个其所有的奇偶测试都是真的，这是判断信息正确的条件。于是剩下的(2^r^-1)种状态，可以用来判断误码的位置。则导出：2^r^-1≥k+r

##### 汉明码计算

确定校验比特和信息比特的位置

- 理论上校验比特可在任何位置，但习惯都是将校验比特放在1、2、4、8、16 ... 位置上。
- 通常是将2^k^位置上，放$r_{k}$ (K≥0)，其余位置放$I_{i}$ (K ≥ 1)

顺序是倒过来的

##### 接收方验证

$S_{2}=R_{2} \oplus I_{4} \oplus I_{3} \oplus I_{2}$

$S_{1}=R_{1} \oplus I_{4} \oplus I_{3} \oplus I_{1}$

$S_{0}=R_{0} \oplus I_{4} \oplus I_{2} \oplus I_{1}$

校正因子全0无措，不全为0有错，错误位置为$S=S_2 S_1 S_0$处，将该比特取反，最后去掉校验比特即可得到正确的信息。

# 点对点协议PPP

## 数据链路层使用的信道类型

数据链路层使用的信道主要有以下两种类型：

- 点对点信道：这种信道使用一对一的点对点通信方式。
- 广播信道：这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送。

## 面向比特的协议HDLC

高级数据链路控制（High-level Data Link Control）是由国际标准化组织制定的面向比特的有序链路层协议。

是为非平衡的链路级操作而研制，采用主从结构，链路上一个主站控制多个从站，主站向从站发送命令，从站向主站返回响应。

### HDLC帧格式

标志字段、地址字段、控制字段、信息字段和帧校验序列组成

首尾都有标志字段

地址+控制+信息是FCS检验区间

FCS检验区间+帧检验序列FCS是透明传输区间

### HDLC帧分类

根据控制字段的前两个比特的取值分类

- 信息帧（I：Information）：用来实现信息的传送，含有信息字段
- 监控帧（S：Supervision）：帧种不包含信息字段，具有监控链路的作用，并能对收到的帧进行确认
- 无编号帧（U：Unnumbered）：对数据链路进行附加控制

## PPP协议

现在全世界使用的最多的数据链路层协议是PPP协议（Point-to-Point Protocol）

PPP协议的改进

- 处理错误检测
- 支持多种协议
- 连接时允许商议IP地址
- 允许身份验证

用户到ISP使用PPP协议

### PPP协议的组成

- 提供将IP数据报封装道串行链路的方法
- 一个**链路控制协议LCP**（Link Control Protocol）：建立、配置和测试数据链路的协议。
- 一套**网络控制协议NCP**（Network Control Protocol）：如为IP协议分配临时IP地址，支持多个网络层协议。

### PPP协议的帧栈

首部，IP数据报，尾部

首部：

- F 7E
- A FF
- C 03
- 协议

信息部分：IP数据报（不超过1500字节）

尾部：

- FCS
- F 7E

标志字段F为0x7E

地址字段A只置为0xFF，表示所有站点都可以接收。因为PPP只用于点对点链路，地址字段实际上并不起作用

控制字段C通常为0x03，表示PPP帧不使用编号

PPP是面向字节的，所有的PPP帧的长度都是整数字节

协议字段：

0x0021 IP数据报

0xC021 PPP链路控制数据LCP分组

0x8021 网络控制数据NCP分组

帧校验字段：冗余码CRC校验

### 透明传输问题

#### 异步传输：字符填充法

- 将信息字段中出现的每一个0x7E字节转变为2字节序列0x7D 0x5E 

- 若信息字段出现0x7D字节，转变为0x7D 0x5D
- 若出现ASCII码控制字符（数值小于0x20）则在该字符前面加入0x7D字节，同时将该字符的编码加以改变

#### 同步传输：比特填充法

5个连续1后面插入0

### 不提供使用序号和确认的可靠传输

PPP不适用序号和确认机制出于以下考虑：

- 数据链路层出差错的概率不大，使用比较简单的PPP协议较为合理。
- 因特网环境下PPP的信息字段放入的数据是IP数据报，数据链路层的可靠传输不保证网络层传输也是可靠的。
- 帧检验序列FCS字段可保证无差错接受。

### PPP协议的工作状态

- 用户拨号接入ISP时，路由器的调制解调器对拨号做出确认，并建立物理连接。
- PC机向路由器发送一系列LCP分组（封装成多个PPP帧）
- 这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP给新接入的PC机分配一个临时的IP地址，使PC机称为因特网上的一个主机。
- 通信完毕后NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接。最后释放的使物理层连接。

![](D:\hub\mynote\计算机网络（校内课程）\image\链路.png)

### PPP协议的特点

- PPP帧种增加了校验字段，PPP在链路层具有差错检测功能；
- PPP的LCP协议提供通信双方进行参数协商的手段；
  - 协商参数有：数据帧最大载荷、身份认证、NCP协议、数据压缩方式等
- PPP帧种增加了协议字段，使得PPP可以支持多种网络层协议如IP,IPX,OSI,CLNP等
- 支持IP的NCP可以建立连接时动态分配IP地址，解决了家庭用户拨号上网的问题。

# 使用广播信道的数据链路层

## 局域网的数据链路层

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限

局域网具有如下的一些主要优点：

- 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源
- 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
- 提高了系统的可靠性、可用性和生存性

## 局域网信道分配策略

广播网中所有站点共享同一个信道，任一站点发送的信息能被所有其他站点接收到。

用户使用的信道称为媒体，决定由谁来使用信道的协议称为“媒体访问控制协议”。

绝大多数的局域网使用广播信道。因此，解决局域网如何使众多用户能够合理而方便的共享通信媒体是个重要问题。

### 问题

若有两个或两个以上的站点同时发送数据，则信号在信道中发生碰撞，数据发送失败，为冲突。

### 解决

广播网中，如何将单一的信道分配给各个不同的用户，是个重要的问题。

## 总线型局域网的特性

总线结构中，如何将单一的信道分配个各个不同的用户？

### 信道分配策略——静态划分信道

- 频分复用、时分复用、波分复用、码分复用
- 将频带或时间片固定分配给各个站点，各个站点有自己的频带或时间片，不会产生冲突

#### 特点

- 站点数目少且固定，且每个站点由大量数据发送，控制协议简单且传输效率高。
- 对于大部分计算机网络，站点数目多且不固定，数据传输由突发性，信道利用率低。
- 代价高，不适合局域网使用

### 信道分配策略

#### 动态媒体接入控制

- 信道不是在用户通信时固定分给用户
- 如异步时分多路复用STDM，各站点仅当由数据发送时，才占用信道发送数据

#### 动态接入控制类型

##### 随机接入

- 又称争用，各站点发送前不需要取得发送权，有数据就发送，发生冲突后采取措施解决冲突
- 适合负载较轻的网络，信道利用率一般不搞，但网络延迟较短
- 以太网核卫星通信

##### 控制接入

- 都是使发送站点首先获得发送权，再发送数据，不会产生冲突
- 当网络负载较重时，可以获得较高的信道利用率
- 主要有轮询（round-robin）和预约（reservation）两种方式
- 光纤分布式数据接口FDDI网络

#### 代表性的媒体访问控制方法

##### 争用协议

- ALOHA协议
- CSMA/CD协议

##### 无冲突协议（略）

- 比特映像媒体访问控制协议（先预约后传输）
- 小时间片轮换优先媒体控制访问协议
- 二进制地址相加协议

##### 有限争用协议（略）



# 以太网的MAC层



# 扩展的以太网



# 虚拟局域网

