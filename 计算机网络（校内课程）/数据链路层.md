[toc]

# 数据链路层的基本概念

## 术语

链路：一条无源的点到点的物理线路段，中间没有任何其他的交换节点

数据链路：除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路

帧：在数据链路层之间传输的数据单位是帧。

碰撞域：在以太网中，如果某个CSMA/CD网络上的两台计算机在同时通信时会发生冲突，那么这个CSMA/CD网络就是一个冲突域（collision domain)。如果以太网中各个网段以集线器连接，因为不能避免冲突，所以它们仍然是一个冲突域。

## 数据链路层的主要功能

向网络层提供**可靠的、透明的**数据传输服务，将源节点的网络层数据可靠地传送到相邻节点的网络层

- 链路管理

  数据链路的建立、维持和释放：两结点通信前要交换一些信息，称为建立数据连接，然后传输数据

- 封装成帧

  数据链路层，数据的传送以帧为单位：界定帧（帧同步）是指接收方能从收到的比特流中区分一个帧的开始和结束的地方

- 流量控制

  发送方发送数据的速率必须使接收方能来得及接收

- 差错控制

  纠错：通过编码技术，接收方自动将差错改正过来

  纠错：检测出帧有错误，要么忽略或重传

- 将数据和控制信息区分开

  数据和控制信息在同一个帧中，收方将其区分开

- 透明传输

  不管所传数据的比特组合，都能在链路上传送；

  若所传的数据的比特片段与某一个控制信息相同，要有可靠机制，保证收方能正确识别

- 寻址

  每一帧都能送到正确的目的地；

  收方也能知道发送方的地址

# 组帧

组帧（framing）就是在一段数据的前后分别添加首部和尾部，这样就构成了一个帧。

目的：让接收方能够准确识别帧的边界

首部和尾部的一个重要作用就是进行帧定界

## 帧定界（帧同步）的方法

### 字节计数法

#### 思想

在帧头设置一个长度域，放置该帧的字节数；收方收到帧后，通过帧的长度，确定帧的开始。

#### 问题

当帧长度域出错，帧同步完全丢失；该方法很少单独使用

### 使用字符填充的首尾定界法

#### 思想

使用特殊的ASCII字符（不可打印的控制字符）作为帧的起始和终止定界符。例如SOH作为开始符，EOT作为结束符。

#### 问题：数据传输不透明

当数据出现定界符SOH或EOT时，如何加以区分时数据还是定界符？

#### 解决

发送端的数据链路层在数据中出现控制字符的前面加一个转义符。接收端的数据链路层在将数据送往网络层之前删除插入的转义字符。

缺点：使用字符来控制帧的传输，数据传输的单位是字符（8bit的ASCII），帧长度时8的倍数；传输任意长度的二进制比特带来不便；

### 使用比特填充的首尾定界法*

#### 思想

使用一个特殊的比特模式01111110作为帧的起始和结束标志。

发送方：边发送边检查数据，没连续发送5个1后在后面自动插入一个0，这样数据中只会连续出现5个1而不会有定界符。

接收方：再收到5个连续的1后将后面的0删掉而会恢复出原始数据。

#### 好处

数据传输的基本单位是比特而不是字符，可用来传输任意长度的二进制比特串，通用性强。

### 违法编码法

#### 前提

物理介质上使用的信号编码有冗余码字时，使用这些荣荣誉的码字作为帧的定界。

#### 举例

如曼彻斯特编码或差分曼彻斯特编码中，有效电平是“低-高”或“高-低”，而“低-低”和“高-高”没有定义，这种违法编码可以作为帧边界。

# 差错控制

## 差错控制技术

### 前向纠错FEC

- 即发送方发送能使接收方检错并纠错的冗余位，纠错任务由接收方完成；常采用海明码。
- 主要应用于没有反向信道或反向传输时间很长的场合

#### 缺点

为纠错附加的冗余码较多，传输效率低

#### 优点

实时性好

### 自动重发请求ARQ

即发送方发送能使接收方**检错**的冗余位，若无差错，则接收方回送一个肯定应答ACK；若有差错，则接收方回送一个否定应答NAK，要求发送方重发。

#### 缺点

信息传递连贯性差

#### 优点

接收端设备简单，只要请求重发，无需纠正错误。

## 差错编码技术

### 差错编码

数据块中插入冗余信息的过程。

思想：判断一个数据块中是否存在传输错误，发送端必须在数据块中插入一些冗余信息，使得数据块中的各个比特建立某种形式的关联，接收端通过验证这种关联关系来判断是否有传输错误。

#### 策略

检错码：能检测出错误，但不能纠正错误，如CRC

纠错码：能知道错误，且知道错误的位置，如海明码

### 检错码（奇偶校验，CRC）

#### 构造

- 检错码（码字、传输帧）=信息位+冗余校验位
- 码字长：n=K（信息位位数）+r（校验位位数）
- 编码效率：R=有效数据位K/码字长n

#### 信息字段和校验字段之间的对应关系

- 校验字段越长，编码的检错能力越强，编码/解码越复杂；附加的冗余信息在整个编码中所占的比例越大，传输的有效成分越低，传输的效率下降。
- 检错码一旦形成，整个检错码将作为一个整体被发往线路，通常的发送顺序使信息字段在前，校验字段在后。

#### 奇偶校验

奇校验：使码字中“1”的总个数为奇数，包括信息位和校验位

偶校验：使码字中“1”的总个数为偶数

奇/偶校验码：最常用的一种检错码，包括

- 水平奇/偶校验码

  其信息字段以字符为单位，校验字段仅含一个比特称为校验比特或校验位。

  例如：使用七单位的ASCII码来构造成八单位的检错码时若采用奇偶校验，校验位的取值应使整个码字包括校验位，1的比特个数为奇数或偶数

  编码效率：Q/(Q+1)

  应用：异步传输用偶校验，同步传输用奇校验

- 垂直奇/偶校验码

  对信息按行、列分组，然后对列进行奇偶校验

  被传输的信息进行分组，并排列为若干行和若干列。组中每行的相同列进行奇/偶校验，最终产生由校验位形成的校验字符（校验行），并附加在信息分组之后传输

  举例：四个ASCII字符（四行）组成一信息组，求垂直奇偶校验码，存在最后一行

  编码效率：PQ/P(Q+1)假设信息分组Q行P列

- 水平垂直奇/偶校验码

  水平校验的基础上进行垂直校验，就是每一行后面都有一个奇偶校验位

  编码效率：PQ/(P+1)(Q+1)假设信息分组为Q行P列

#### 循环冗余码CRC

计算机和数据通信中使用的最广泛的检错码，漏检率低，可用简单的电路实现。

给定一个k比特的帧或比特，发送方生成n比特的序列（也称帧检测序列FCS），形成（k+n）的码字，该码字能被某个事先确定的数整除。接收方用相同的数去除收到的帧，如果无余数，则认为数据帧无差错。

任意一个由二进制位串组成的代码都可以和一个系数仅为'0'和'1'取值的多项式一一对应。

多项式表示：即将k比特的数据用k项对象是表示，它的各项为X^(k-1)^...x^0^，它的系数为数据中对应位的0或1.

例如：1010111对应x^6^+x^4^+x^2^+x+1

多项式位x^5^+x^3^+x^2^+x+1对应101111

##### CRC计算

假设待传数据为1010001101 k bit。我们在M的后面再添加供差错检测用的n bit冗余码一起发送。

计算方法：

用二进制的模2运算进行2^n^乘m的运算，这相当于再M后面添加n个0.

得到的(k+n)bit的数除以事先选定好的长度为(n+1)bit的数P，得出商是Q而余数是R，余数R比除数P少1个比特。

核心问题：P如何选定？P若选定则n就确定了。

发送方和接收方**事先约定**生成多项式

- 生成多项式的最高位和最低为都必须为1

生成多项式P的用处

- 发送方用它生成冗余位；用P生成R
- 接收方用它判断是否有错

实现

- 不同的P有不同的编码电路，用简单的移位寄存器电路硬件实现
- 发送方通过编码电路产生冗余位，接收方用相似电路检测错误

若P为r阶（r+1）位比特，生成r位冗余位

##### 发送方用P生成冗余位

- P(x) 生成多项式

- M(x) 信息多项式

- R(x) 冗余多项式

- T(x) 传输帧多项式

- 发送方用P(x)产生冗余位

  2^n^*M(x)/P(x)产生冗余多项式R(x)附加到M(x)后形成T(x)变成带校验位的传输帧多项式

##### 接收方用P进行校验

- T(x)/P(x)

  除不尽有错，除得尽无措或漏检

- 有错分析

  只要得出的余数R不为0，就表示检测到了差错。即用收到的比特流（2^n^M+R）除以P，看得出的余数是否为0.

  但这种检测方法并不能确定究竟是哪一个或哪几个比特出现了差错。

  一旦检测出差错，就丢弃这个出现差错的帧。

##### 接收方用P进行校验（漏检）

收到：T(x)+E(x)；其中E(x)为出错多项式

漏检，即[T(x)+E(x)]/P(x)=0

因为T(x)/P(x)=0

所以E(x)/P(x)=0

即若P(x)是E(x)的因子，将可能漏检

选取合适的P(x)，使P(x)不成为E(x)的银子，则可避免漏检

CRC不保证检测出所有的传输错误，要选择位数足够的P，可以使得差错概率足够小

例如：CRC-16和CRC-CCITT可以检测出所有1、2、奇数个、突发长度小于等于16比特错。17比特突发错的99.997%，18比特或更长比特突发错的99.998%

### 纠错码

#### 汉明码

汉明码是信道编码，通过插入冗余信息，使得在有差错的信道中实现无差错的传输

##### 码距（Hamming Distance）

一个编码系统中任意两个合法编码（码字）之间不同的二进位数叫这两个码字的码距。

例如10001001与10110001的码距为3

整个编码系统两个码字的最小距离就是该系统的码距

##### 结论

- 如果要检测出d比特的错，编码集的汉明码距至少为d+1
- 如果要纠正d比特的错，则编码集的汉明距离至少应该为2d+1

例如4个有效码字：它们是000000，000111，111000，111111，汉明距离为3，能纠正1比特错

##### 基本思想

k比特信息后附加r比特冗余信息（校验比特），构成n=k+r比特的码字，其中每个校验比特和某几个特定的信息比特构成偶校验关系。

接收端对r个奇偶校验关系进行校验，即将每个校验比特与关联的信息进行相加（异或），相加结果为校正因子。

- 如果没有错，则r个校正因子都为0
- 若校正因子不全为0，根据校正因子取值，确定错误发生的位置

##### 发送方冗余计算

根据信息位长度（如每帧k位），计算出所需冗余位位数r：

- 纠正一位错，满足2^r^ ≥ k+r+1
- 原理：求汉明码时的一项基本考虑时确定所需最少的校验位数r。考虑长度为k位的信息，若附加了r个校验位，则所发送的总长度位K+r。在接收端中要进行r个奇偶检查，每个检查结果或是真或是伪。这个奇偶检查的结果可以表示成一个r位的二进制数，它可以确定最多2^r^种不同状态。这些状态中必有一个其所有的奇偶测试都是真的，这是判断信息正确的条件。于是剩下的(2^r^-1)种状态，可以用来判断误码的位置。则导出：2^r^-1≥k+r

##### 汉明码计算

确定校验比特和信息比特的位置

- 理论上校验比特可在任何位置，但习惯都是将校验比特放在1、2、4、8、16 ... 位置上。
- 通常是将2^k^位置上，放$r_{k}$ (K≥0)，其余位置放$I_{i}$ (K ≥ 1)

顺序是倒过来的

##### 接收方验证

$S_{2}=R_{2} \oplus I_{4} \oplus I_{3} \oplus I_{2}$

$S_{1}=R_{1} \oplus I_{4} \oplus I_{3} \oplus I_{1}$

$S_{0}=R_{0} \oplus I_{4} \oplus I_{2} \oplus I_{1}$

校正因子全0无措，不全为0有错，错误位置为$S=S_2 S_1 S_0$处，将该比特取反，最后去掉校验比特即可得到正确的信息。

# 点对点协议PPP

## 数据链路层使用的信道类型

数据链路层使用的信道主要有以下两种类型：

- 点对点信道：这种信道使用一对一的点对点通信方式。
- 广播信道：这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送。

## 面向比特的协议HDLC

高级数据链路控制（High-level Data Link Control）是由国际标准化组织制定的面向比特的有序链路层协议。

是为非平衡的链路级操作而研制，采用主从结构，链路上一个主站控制多个从站，主站向从站发送命令，从站向主站返回响应。

### HDLC帧格式

标志字段、地址字段、控制字段、信息字段和帧校验序列组成

首尾都有标志字段

地址+控制+信息是FCS检验区间

FCS检验区间+帧检验序列FCS是透明传输区间

### HDLC帧分类

根据控制字段的前两个比特的取值分类

- 信息帧（I：Information）：用来实现信息的传送，含有信息字段
- 监控帧（S：Supervision）：帧种不包含信息字段，具有监控链路的作用，并能对收到的帧进行确认
- 无编号帧（U：Unnumbered）：对数据链路进行附加控制

## PPP协议

现在全世界使用的最多的数据链路层协议是PPP协议（Point-to-Point Protocol）

PPP协议的改进

- 处理错误检测
- 支持多种协议
- 连接时允许商议IP地址
- 允许身份验证

用户到ISP使用PPP协议

### PPP协议的组成

- 提供将IP数据报封装道串行链路的方法
- 一个**链路控制协议LCP**（Link Control Protocol）：建立、配置和测试数据链路的协议。
- 一套**网络控制协议NCP**（Network Control Protocol）：如为IP协议分配临时IP地址，支持多个网络层协议。

### PPP协议的帧栈

首部，IP数据报，尾部

首部：

- F 7E
- A FF
- C 03
- 协议

信息部分：IP数据报（不超过1500字节）

尾部：

- FCS
- F 7E

标志字段F为0x7E

地址字段A只置为0xFF，表示所有站点都可以接收。因为PPP只用于点对点链路，地址字段实际上并不起作用

控制字段C通常为0x03，表示PPP帧不使用编号

PPP是面向字节的，所有的PPP帧的长度都是整数字节

协议字段：

0x0021 IP数据报

0xC021 PPP链路控制数据LCP分组

0x8021 网络控制数据NCP分组

帧校验字段：冗余码CRC校验

### 透明传输问题

#### 异步传输：字符填充法

- 将信息字段中出现的每一个0x7E字节转变为2字节序列0x7D 0x5E 

- 若信息字段出现0x7D字节，转变为0x7D 0x5D
- 若出现ASCII码控制字符（数值小于0x20）则在该字符前面加入0x7D字节，同时将该字符的编码加以改变

#### 同步传输：比特填充法

5个连续1后面插入0

### 不提供使用序号和确认的可靠传输

PPP不适用序号和确认机制出于以下考虑：

- 数据链路层出差错的概率不大，使用比较简单的PPP协议较为合理。
- 因特网环境下PPP的信息字段放入的数据是IP数据报，数据链路层的可靠传输不保证网络层传输也是可靠的。
- 帧检验序列FCS字段可保证无差错接受。

### PPP协议的工作状态

- 用户拨号接入ISP时，路由器的调制解调器对拨号做出确认，并建立物理连接。
- PC机向路由器发送一系列LCP分组（封装成多个PPP帧）
- 这些分组及其响应选择一些PPP参数，和进行网络层配置，NCP给新接入的PC机分配一个临时的IP地址，使PC机称为因特网上的一个主机。
- 通信完毕后NCP释放网络层连接，收回原来分配出去的IP地址。接着，LCP释放数据链路层连接。最后释放的使物理层连接。

![](.\image\链路.png)

### PPP协议的特点

- PPP帧种增加了校验字段，PPP在链路层具有差错检测功能；
- PPP的LCP协议提供通信双方进行参数协商的手段；
  - 协商参数有：数据帧最大载荷、身份认证、NCP协议、数据压缩方式等
- PPP帧种增加了协议字段，使得PPP可以支持多种网络层协议如IP,IPX,OSI,CLNP等
- 支持IP的NCP可以建立连接时动态分配IP地址，解决了家庭用户拨号上网的问题。

# 使用广播信道的数据链路层

## 局域网的数据链路层

局域网最主要的特点是：网络为一个单位所拥有，且地理范围和站点数目均有限

局域网具有如下的一些主要优点：

- 具有广播功能，从一个站点可很方便地访问全网。局域网上的主机可共享连接在局域网上的各种硬件和软件资源
- 便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
- 提高了系统的可靠性、可用性和生存性

## 局域网信道分配策略

广播网中所有站点共享同一个信道，任一站点发送的信息能被所有其他站点接收到。

用户使用的信道称为媒体，决定由谁来使用信道的协议称为“媒体访问控制协议”。

绝大多数的局域网使用广播信道。因此，解决局域网如何使众多用户能够合理而方便的共享通信媒体是个重要问题。

### 问题

若有两个或两个以上的站点同时发送数据，则信号在信道中发生碰撞，数据发送失败，为冲突。

### 解决

广播网中，如何将单一的信道分配给各个不同的用户，是个重要的问题。

## 总线型局域网的特性

总线结构中，如何将单一的信道分配个各个不同的用户？

### 信道分配策略——静态划分信道

- 频分复用、时分复用、波分复用、码分复用
- 将频带或时间片固定分配给各个站点，各个站点有自己的频带或时间片，不会产生冲突

#### 特点

- 站点数目少且固定，且每个站点由大量数据发送，控制协议简单且传输效率高。
- 对于大部分计算机网络，站点数目多且不固定，数据传输由突发性，信道利用率低。
- 代价高，不适合局域网使用

### 信道分配策略

#### 动态媒体接入控制

- 信道不是在用户通信时固定分给用户
- 如异步时分多路复用STDM，各站点仅当由数据发送时，才占用信道发送数据

#### 动态接入控制类型

##### 随机接入

- 又称争用，各站点发送前不需要取得发送权，有数据就发送，发生冲突后采取措施解决冲突
- 适合负载较轻的网络，信道利用率一般不搞，但网络延迟较短
- 以太网核卫星通信

##### 控制接入

- 都是使发送站点首先获得发送权，再发送数据，不会产生冲突
- 当网络负载较重时，可以获得较高的信道利用率
- 主要有轮询（round-robin）和预约（reservation）两种方式
- 光纤分布式数据接口FDDI网络

#### 代表性的媒体访问控制方法

##### 争用协议

- ALOHA协议
- CSMA/CD协议

##### 无冲突协议（略）

- 比特映像媒体访问控制协议（先预约后传输）
- 小时间片轮换优先媒体控制访问协议
- 二进制地址相加协议

##### 有限争用协议（略）

- 思想：网络轻负载时使用竞争策略，重负载时使用无冲突策略
- 自适应步进树协议

## 争用协议

### 争用协议特性

- 随机访问：任何站点都无法预计其发送时刻
- 竞争发送：所有发送站点自由竞争信道使用权
- ALOHA系统和它的后继者CSMA/CD都是争用协议的代表

### 争用协议扩展

- 想发就发，冲突重发 -> ALOHA
- ALOHA+划分时隙 -> 时隙ALOHA
- ALOHA+载波检测 ->  CSMA
  - 载波检测：发送前先监听信道，信道空再发
- CSMA+冲突检测 -> CSMA/CD
  - 冲突检测：发送时，边发边测

### ALOHA系统

多个用户竞争使用单一信道的系统

思想：

- 任何用户有数据发送就可以发送
- 每个用户监听信道来获知数据传输是否成功
- 发现数据传输失败后，各自等待一段随机时间，再重新发送

#### 信道分析

不断有新的数据帧发送，冲突帧需要重发，系统的吞吐量是重要指标

系统吞吐量：单位时间内系统能够成功发送的新的数据帧的平均数量。

##### 结论

- ALOHA系统最大的信道利用率18.4%
- ALOHA系统信道利用率低，各个站自由发送数据，碰撞概率增大。

### 时隙ALOHA

信道时间分为离散的时间片，每个时间片用来发送一个数据帧。一个站点有数据发送时，必须等到下个时间片开始才能发送。

最大信道利用率36.8%

### CSMA/CD协议

载波监听Carrier Sense 多点接入Multiple Access 碰撞检测Collision Detection

最初以太网是将许多计算机连接到一根总线上，当初认为该方法简单可靠，因为总线上没有源器件。

#### 以太网的广播方式发送

- 总线上每一个工作的计算机都能检测到B发送的数据信号。
- 由于只有D的地址与数据帧首部写入的目的地址一致，因此只有D才能接收这个数据帧。
- 其他所有的计算机（A,C和E）都检测到不是发给他们的数据帧，丢弃数据帧而不接收。
- 广播特性的总线上实现一对一通信。

#### 通信简便的两种措施

- 采用较为灵活的无连接的工作方式，不必先建立连接就直接发送数据
- 对发送的数据帧不编号，不要求对方发回确认。
  - 局域网信道质量好，因信道质量产生差错的概率很小。

#### 以太网提供的服务

- 不可靠交付，尽最大努力交付。
- 目的站点收到有差错的数据帧就丢弃帧。
- 高层发现丢失数据帧而进行重传，但以太网不知道是重传的帧。

#### 载波监听

总线上没有什么载波，本质上就是用电子技术检测总线上有没有其他计算机发送的数据信号

#### 冲突发生

**电磁波在总线上的优先传播速率的影响**

- 某个站点监听到总线是空闲的不代表总线真正是空闲的。
- A向B发送信息，要经过一定的时间才能传送到B。
- B若在A发送的信息到达B之前发送自己的帧（因为这时候B检测不到A发送的信息）则必然要在某个时间和A发送的帧碰撞
- 碰撞的根本原因是电磁波在媒体上的传播速度总是有限的
- 例如：电磁波在1km电缆上的传播时延约为5μs

##### 争用期（碰撞窗口）

网上任一站点在开始发送后，最多经过2τ时间就能确认是否传输成功

将以太网端到端往返时延2τ称为争用期或碰撞窗口

经过争用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞

作用：确定最短有效帧长，即最短有效帧长为（2τ*带宽）

以太网取51.2μs为争用期长度

##### 争用期长度

对于10Mb/s以太网，在争用期内可以发送512bit即64字节

以太网发送数据时，若前64字节没有冲突，则后续数据就不会发生冲突，即如果发生冲突，就一定是在发送的前64字节之内。

由于一旦检测到冲突就终止发送，这时发送的数据一定小于64字节。因此以太网规定最短有效帧长为64字节，长度小于64字节的帧都是冲突而异常终止的无效帧。

#### 冲突检测

当几个站点同时发送数据时，总线上的信号电压摆动值会增加（互相叠加）。当一个站点检测到信号电压摆动值超过一定的阈值，就认为总线上至少有两个站点同时在发送数据。

#### 冲突处理

发生碰撞时，总线上的信号发生了严重的失真，无法恢复有效信息。

一旦发现总线上发生碰撞，就要立即停止发送，等待随机时间后再次发送

##### 强化碰撞

除了停止发送数据外，还要继续发送若干比特的人为干扰信号（jamming signal），以便让所有用户都知道现在发生了碰撞。

原因：假设冲突点离A很远，离B很近，叠加数据远距离传送到A可能被A忽略，A继续发送。

强化冲突的违规码长度介于32-64比特之间，不易被忽略。

#### 如何选择重发时间

##### 二进制指数退避算法（truncated binary exponential backoff）

算法如下：

1. 基本退避时间T=2τ（争用期）
2. k=min（重传次数，10）
3. r=在[0,1,...,(2^k^-1)]中随机取一个数
4. 退避时间=rT

限定最大重传次数=16，若发送16次仍然不成功，发送失败

#### CSMA/CD重要特性

使用CSMA/CD协议的以太网不能进行全双工通信，只能进行双向交替通信（半双工）

每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性，称为**发送的不确定性**

要使碰撞的概率减小，必须使整个以太网的平均通信量远小于以太网的最高数据率。

#### 要点

- 先听后讲

  发送前先监听介质，若介质空闲，立即发送；介质忙，继续监听直到介质空闲。

- 边讲边听

  发送过程进行冲突检测

- 冲突停止

  发送过程中检测到冲突，立即停止发送

- 随机等待

  停止发送后必须等待随机事件再监听介质

### 以太网信道利用率

- 以太网信道被占用的情况
- 争用期长度为2τ，即端到端传播时延两倍，检测到碰撞后不发送干扰信号
- 帧长为L（bit），数据发送率为C（b/s），因而帧发送时间为L/C=T

#### 以太网信道被占用的情况

一个帧从开始发送，经可能发生的碰撞后，将重传数次，到发送成功且信道转为空闲（即再经过时间τ使得信道上无信号传播）时位置，是发送一帧所需的平均时间。

#### 参数a

提高以太网的信道利用率，必须减小τ与T之比，定义参数a，是以太网单程端到端时延τ与帧发送时间T之比

a趋近于0表示一发生碰撞立即可以检测出来，停止发送，信道利用率高

a越大，表面争用期所占的比例增大，每发生一次碰撞就浪费许多信道资源，信道利用率明显降低

#### 以太网参数要求

数据速率一定时，以太网的连线的长度受到限制，否则τ的数值会太大

以太网帧不能太短，否则T值太小，a值太大

#### 信道利用率最大值Smax

理想化情况下，以太网上各站发送的数据都不会发生碰撞（显然已经不是CSMA/CD，而是采用一种特殊调度方法），即总线一旦空闲就有某一站立即发送数据。

发送一帧占用线路的时间是T+τ，而帧本身的发送时间是T。

于是我们计算出理想情况下极限利用率为：$S_{max}=\frac{T_0}{T_0+\tau}=\frac{1}{1+a}$

# 以太网的MAC层

以太网是是美国施乐公司1975年研制成功的。

以太网用无源电缆传送数据帧，并用历史上表示传播电磁波的以太来命名。

两个标准：

- 1980年DEC、Intel、Xerox公司联合提出10Mb/s的以太网规约
- 1983年IEEE的802委员会定制802.3标准
- DIX Ethernet V2标准与IEEE的802.3标准只有很小的差别，因此人们常将802.3局域网简称为“以太网”

## IEEE802

IEEE 802委员会是局域网标准的主要定制者，提出的局域网参考模型主要定义了物理层和数据链路层的规范，相当于OSI的下两层：

- 物理层：与OSI模型中类似，物理层负责与传输介质的连接，并在传输介质上传输比特流，因此，它描述和规定了与传输介质接口的特性。
- 数据链路层：OSI模型中数据链路层的功能在IEEE802模型中分成了两个子层（MAC和LLC）。

### 数据链路层两个子层

为了使数据链路层能够更好适应多种局域网标准，802委员会就把局域网的数据链路层拆成两个子层：

- 逻辑链路控制LLC（Logical Link Control）子层

  逻辑链路控制子层的主要功能使屏蔽对各种不同物理网络的访问方法差异，向上提供数据传输服务的统一的逻辑接口

- 媒体介入控制MAC（Medium Access Control）子层

  媒体介入控制子层主要是控制对传输介质的访问，并在物理层的基础上实现无差错通信，该子层随不同的物理网络差异较大

#### 拆分的好处

与介入到传输媒体有关的内容都放在MAC子层，而LLC子层则与传输媒体无关，不管采用何种协议的局域网对LLC子层来说都是透明的。**局域网对LLC子层不可见。**

#### TCP/IP一般不考虑LLC子层

由于TCP/IP使用的局域网是DIX Ethernet V2而不是802.3标准中的几种局域网，因此现在802委员会定制的逻辑链路控制层LLC作用不大了，很多厂商生产的网卡就仅装有MAC协议而没有LLC协议。

### 适配器作用

计算机要连接到局域网需要网卡

- 网络接口板又被称为通信适配器（adapter）或网络接口卡NIC（Network Interface Card）
- 主要功能：
  - 串并行转换
  - 数据缓存
  - 以太网协议
  - 在计算机的操作系统安装设备驱动程序

## 计算机通过网卡和局域网通信

IP地址在存储器中，CPU生成和处理数据，通过和适配器的并行通信把帧发送到局域网或从局域网接收帧，适配器含硬件地址。适配器到局域网是串行通信。

### MAC层硬件地址

局域网中，硬件地址也被称为物理地址，或MAC地址

802标准为局域网规定一个48位的全球地址，是指固化在网卡ROM中的地址。

802标准所说的“地址”严格地讲应当是每一个站的“名字”或标识符

经典定义：“**名字**是我们要寻找的哪个资源，**地址**指出资源在何处，**路由**告诉我们该如何到达该处”

### MAC地址分配与描述

IEEE的注册管理机构RA（Registration Authority）是局域网法定的全球管理机构。负责分配地址字段6个字节中的前三个字节（即高位24位）

网卡生产厂家向IEEE购买这3字节构成的一个号（机构唯一标识符OUI）低位三字节厂家自行指派，称为扩展的唯一标识符EUI。

网卡地址或标识符常写为EUI-48，IEEE规定地址第一字段第一字节最低位为I/G比特；

“0”单站地址；“1”组地址

802.5和802.6字节顺序是高位在前

802.3和802.4字节顺序是低位在前

### 网卡的硬件地址

路由器由于同时连接到两个网络上，因此有两块网卡和两个硬件地址

### 网卡检查MAC地址

网卡从网络上每收到一个MAC帧就首先用硬件检查MAC帧中的MAC地址

- 如果是发往本站的帧则收下，然后再进行其他的处理。
- 否则就将此帧丢弃，不再进行其他的处理。

“发往本站的帧”包括以下三种帧：

- 单播（unicast）帧（一对一）
- 广播（broadcast）帧（一对全体）
- 多播（multicast）帧（一对多）

### 以太网MAC帧格式

DIX V2和IEEE 802.3帧格式的区别主要在于第三个字段不同，DIX V2是协议类型，802.3为帧长度字段

![](.\image\以太网的MAC帧格式.png)

类型字段标志上一层使用的是什么协议，以便把收到的MAC帧的数据上交给上一层的这个协议

数据字段（46-1500字节）的正式名称是MAC客户数据字段

最小长度64字节-18字节的首部和尾部 = 数据字段的最小长度

当传输媒体误码率为1\*10^-8^时，MAC子层可使未检测到的差错小于1\*10^-14^

当数据字段长度小于46字节时，应再数据字段的后面加入整数字节的填充字段，以保证以太网的MAC帧不小于64字节。

为了达到比特同步，在传输媒体实际传送的要比MAC帧多8个字节；因为当一个站开始接收MAC帧时，没有与到达的比特流同步，因此MAC帧开始若干比特无法接收，这样使得整个帧无效，所以需要插入同步码。

- 在帧前插入8字节中的第一个字段共7个字节，是前同步码，用来实现MAC帧比特同步。
- 第二个字段是帧开始定界符，表示后面的信息就是MAC帧。

#### 无效的MAC帧

- 数据字段的长度和长度字段的值不一致
- 帧的长度不是整数个字节
- 用收到的帧检验序列FCS查出有差错
- 数据字段的长度不在46-1500字节之间
- 有效的MAC帧长度为64-1518字节之间
- 对于检查出的无效MAC帧直接丢弃，以太网不负责重传丢弃的帧

#### 帧间最小间隔

- MAC子层标准还规定帧间最小间隔为9.6μs，相当于96bit的发送时间
- 一个站在检测到总线开始空闲后，还要等待9.6μs才能再次发送数据
- 这样做是为了使刚刚收到数据帧的站的接收缓存来得及清理，做好接受下一帧的准备

# 扩展的以太网

## 局域网互联与互联设备

为什么要局域网互联？

- 局域网覆盖距离有限

  单个局域网覆盖的距离往往不能满足应用的需要

- 局域网能支持的联网计算机数目有限

  单个局域网所能连接的计算机数目不能满足应用的需要

- 局域网上能传输的数据有限

  单个局域网所容许的通信量往往不能满足应用的需要

由于网络是分层次实现的，而局域网又各有不同的标准，因此网络互连的本质就是在不同协议层次上实现协议的彼此转换。

## 互联设备

### 路由器（Router）

### 网关（Gateway）

### 转发器（Repeater，重发器，中继器）

用于物理层上实现两个同构型局域网之间的互连

常用于两个同轴电缆以太网，将信号放大整形后，以延申网络的传输距离，不具有信号通路的选择功能

### 集线器（Hub）

任一时刻每个系中只能由一个站发送数据

若每个局域网的最大吞吐量为10Mb/s，则整个系统为30Mb/s的最大吞吐量

优点：

- 使原来属于不同碰撞域的局域网上的计算机能够跨碰撞域通信
- 扩大局域网覆盖的地理范围

缺点：

- 碰撞域增大，总吞吐量不提高
- 如果不同碰撞域使用不同数据率，那么不能用集线器互连
- 不具备自动转发和自动寻址能力，即不能交换

### 网桥（Bridge）和 交换机（Switch）

扩展以太网的常用方法使在数据链路层进行。

早期使用网桥，现在使用以太网交换机

#### 网桥

- 网桥工作在数据链路层

- 根据MAC帧的目的地址对收到的帧进行转发和过滤

- 网桥收到一个帧并不是向所有接口转发此帧，而是先检查此帧的目的MAC地址，在确定将该帧转发到哪个接口或丢弃

##### 特点

- 用于在数据链路层上实现在数据链路层以上使用相同协议的局域网互联
- 负责完成物理层和数据链路层协议的转换
- 具有路由选择功能，可提高网络的整体效率

##### 依据不同路由确定方法

- 固定路由网桥
- 透明网桥
- 源路由网桥

#### 交换机

- 交换式集线器可明显地提高以太网的性能
- 交换时集线器常称为以太网交换机或第二层交换机，强调这种交换机工作在数据链路层
- 交换机的每一个接口是一个碰撞域

##### 特点

- 本质就是一个多接口网桥（通常有十几个）

- 每个接口都直接与一个单台主机或另一个以太网交换机相连，并一般都工作在全双工方式

- 具有并行性，能同时连通多对接口，使多对主机能同时通信
- 以太网交换机的接口有存储器，能够在输出端繁忙的时候把到来的帧缓存
- 即插即用，内部帧交换表通过自学习算法逐渐建立
- 以太网交换机使用专用交换结构芯片，硬件转发比软件转发的网桥要快很多
- 性能远超普通集线器

##### 优点

- 从共享总线以太网转到交换式以太网时，所有接入设备的硬件软件和适配器不需要任何改动
- 以太网交换机有多种速率接口，方便不同情况的用户

##### 交换方式

###### 存储转发方式

- 把整个数据帧先缓存再处理

###### 直通（cut-through）方式

- 接收数据帧的同时立刻按数据帧的目的MAC地址决定转发接口，提高转发效率
- 不检查差错就直接转发，可能会转发无效帧

某些情况下，仍需要基于软件的存储转发方式进行交换，例如，当需要进行线路速率匹配、协议转换或差错检测时。

##### 以太网交换机的自学习功能

- 初始交换表是空的
- A向B发送一帧，从接口1进入交换机，交换机查找交换表没有找到转发给B的接口
- 交换机把源地址A和接口1写入交换表，向接口1以外的所有接口广播帧
- 目的地址不符的接口丢弃该帧
- B向A发送一帧，该帧从接口3进入交换机
- 交换机收到帧后查找交换表，发现MAC地址有A，从接口1转发
- 交换机把帧源地址B和接口3写入交换表

考虑到有时要在交换机的接口更换主机，或者主机要更换其他适配器，这就需要更改交换表中的项目。为此，在交换表中的项目都设有有效时间。过期的项目就被自动删除。

交换表中MAC地址根据源MAC地址写入，但在转发时将此MAC地址当作目的地址。

以太网交换机的自学习方法使得以太网交换机即插即用，不必人工配置。

##### 交换机生成树协议STP(Spanning Tree Protocol)

不改变网络的实际拓扑，但在逻辑上切断某些链路，使得从一台主机到其他主机都是无环路的树状结构，消除兜圈子的情况。

### 从总线道以太网道星形以太网

- 早期，以太网采用无源的总线结构
- 现在采用以太网交换机的星形结构
- 总线以太网使用CSMA/CD协议，半双工方式工作
- 以太网交换机不使用共享总线，没有碰撞问题，因此不使用CSMA/CD协议，以全双工方式工作。但仍采用以太网的帧结构。

## 虚拟局域网

- 利用以太网交换机可以很方便地实现虚拟局域网
- 虚拟局域网VLAN是由一些局域网网段构成的与物理位置无关的逻辑组
  - 这些网段由某些共同的需求
  - 每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的工作站属于哪一个VLAN
- 虚拟局域网只是局域网给用户提供的服务，而不是一种新型局域网

### 以太帧格式

虚拟局域网允许再以太网的帧格式中插入一个四字节的标识符，称为VLAN标记（tag），用来指明发送该帧的工作站属于哪一个虚拟局域网。

其中长度/类型=802.1Q标记类型为2字节；标记控制信息为2字节，其中包含用户优先级，CFI和VID

### 优点

- 安全性好

  没有路由的情况下，不同虚拟局域网间不能相互通信

- 网络分段

  可将物理网络逻辑分段，而不是按物理分段。可将不同地点、不同部门的计算机划分在同一个局域网上

- 提供较好的灵活性

  方便地将一个站点加入或从VLAN中删除

# 高速以太网

速度达到100Mb/s的以太网称为高速以太网

在双绞线上传送100Mb/s基带信号的星形拓扑以太网，仍使用IEEE802.3的CSMA/CD协议。100BASE-T以太网

## 特点

全双工方式下工作无冲突发生，不使用CSMA/CD协议。

MAC帧格式仍然是802.3标准规定的

最短帧长不变，但将一个网段的最大电缆长度减小到100m

帧间时间间隔从9.6μs改为0.96μs

## 载波延伸（carrier extension）

- 吉比特以太网在半双工方式时，就必须进行碰撞检测
- 由于数据率提高了，因此只有减小最大最大电缆长度或增大帧的最小长度
- 吉比特以太网仍然保持一个网段最大长度为100m，但采用了“载波延伸”的办法，使最短帧长仍为64字节（保持兼容）同时将争用时间增大为512字节。

#### 在短MAC帧后面加上载波延伸

- 凡发送MAC帧长不足512字节时，就用一些特殊的字符填充在帧后面，使MAC帧的发送长度增大到512字节，但这对有效载荷没有影响。
- 接收端接到MAC帧后，要将填充的特殊字符删除后向高层交付

## 10吉比特以太网

- 以太网的帧格式完全相同
- 保留了802.3标准规定的以太网最小和最大帧长，便于升级
- 不使用铜线而是只是用光纤作为传输媒体
- 只工作在全双工方式，没有争用问题，不适用CSMA/CD协议
