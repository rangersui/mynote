[toc]

# 网络层提供的两种服务

网络层提供的两种服务分别是：**虚电路服务和IP数据报服务**。

## 虚电路服务

**虚电路服务**：面向**连接**的服务，在通信前，建立一条**虚电路VC**，分配通信所需要的资源，在通信过程中，只需要在在分组首部填入虚电路编号，减小了分组的开销。

## IP数据报服务

**IP数据报**（分组）：**网络层向上只提供简单灵活的，无连接的，尽最大努力交付的数据报服务。**事前可以不先建立连接，每个分组独立无关，**网络层不提供服务质量的保证**，主机之间的通信可靠性主要依托于运输层。

| 对比内容                   | 虚电路服务                                 | 数据报服务                                 |
| -------------------------- | ------------------------------------------ | ------------------------------------------ |
| 思路                       | 可靠通信由网络负责                         | 可靠通信由用户主机保证                     |
| 连接的建立                 | 必须有                                     | 不需要                                     |
| 终点地址                   | 仅连接的时候使用，分组使用虚电路编号       | 每个分组都有终点的地址号                   |
| 分组的转发                 | 属于同一虚电路的分组按照同一路由的进行转发 | 每个分组独立选择路由进行转发               |
| 结点出故障                 | 所有通过出故障的结点的虚电路均不能工作     | 出故障可能会丢失分组，一些路由可能发生变化 |
| 分组的顺序                 | 总是按照发送顺序到达终点                   | 到达终点的时间不一定发生按发送顺序         |
| 端到端的差错处理和流量控制 | 可以由网络负责，也可以由用户主机负责       | 由用户主机负责                             |

# 网际协议IP

当前普遍使用的是IPv4。

#### 相关概念：

（1）**物理层**中间设备：**转发器。**
（2）**数据链路层**中间设备：**网桥。**同一个网桥互连的网段仍是一个网络号。
（3）**网络层**中间设备：**路由器。**每一个接口处有一个网络号。
（4）**网络层以上**：**网关**。

**网络互连**：指的是路由器进行网络互联和路由选择。（某些时候会把路由器称作网关。

IP协议的作用：使各个不同网络中的主机处在**虚拟互连网络**中，物理网络具有异构性，使用IP协议将性能各异的网络在网络层上表现为同一种网络，这样的虚拟网络称为**虚拟互连网络。**

#### IP分类

三个阶段：
（1）分类的IP地址。
（2）子网的划分。
（3）构成超网。

##### （一）分类的IP地址

分类的IP地址由两个**固定长度字段**组成，第一个字段是**网络号**，网络号在整个互联网范围内唯一，第二个字段是**主机号**，主机在指明的网络号里面唯一。

| 地址类型 | 网络号                           | 主机号 | 十进制  |
| -------- | -------------------------------- | ------ | ------- |
| A类地址  | 0xxxxxx（8位）                   | 24位   | 1~126   |
| B类地址  | 10xxxxxxxxxxxxx（16位）          | 16位   | 128~191 |
| C类地址  | 110xxxxxxxxxxxxxxxxxxxxx（24位） | 8位    | 192~223 |
| D类地址  | 1110多播地址                     |        |         |
| E类地址  | 1111保留使用                     |        |         |

**ATTENTION:**
1、A类中全0网络号代表本网络，全1地址01111111代表**环回测试**。
2、主机号全0代表本主机，全1表示所有主机。
故得到下表：

| 网络类别 | 可指派的网络数        | 第一个可指派的网络 | 最后一个可指派的网络 | 每个网络可指派主机数 |
| -------- | --------------------- | ------------------ | -------------------- | -------------------- |
| A        | 2^7^-2(减去全0、全1） | 1                  | 126                  | 2^24^−2              |
| B        | 2^14^                 | 128.0              | 191.255              | 2^16^−2              |
| C        | 2^21^                 | 192.0.0            | 223.255.255          | 2^8^-2               |

路由器总是连接两个及以上的IP地址，每个接口都有一个网络号。

**IP地址和硬件地址的区别：**
硬件地址是数据链路层和物理层用的地址，IP地址是网络层及以上各层使用的逻辑地址。

###### 地址解析ARP协议

IP地址--------ARP协议------->物理地址。
每个主机都有一个ARP高速缓存，用来存储各主机和路由器IP地址到硬件地址的映射表。

**ARP高速缓存**在同一个局域网内起作用，通信两端必然处于同一个网络。
**路由表**指明的是前往某个网络应该从哪里走。

当A->B发送一个IP数据报，ARP工作四种情况：
（1）发送方是主机，B主机与A主机位于同一个网络，则可以直接交付；
（2）发送方是主机，B主机与A主机位于不同网络，A发送ARP请求分组，在A存在的网络内进行广播，并将IP数据报交给路由器R1（也存在B刚入网，A的告诉缓存中没有B的IP地址，从而进行广播）；
（3）发送方是路由器R，目的主机与R位于同一个网络，可直接交付；
（4）发送方是路由器R，目的主机与R不在同一个网络，则R发送ARP请求分组，在R存在的网络内进行广播，类推。

**为什么要用ARP？**
因为不同的网络使用不同的硬件地址，异构的网络相互转换连接非常复杂。转换为IP地址后，方便了网络之间的通信。

IP数据报格式注意：
（1）以太网规定的MTU=1500字节（最大传送单元Max Transfer Unit）
（2）除了最后一个数据报片，其他数据报片一定是8字节的倍数。因为片偏移是以8个字节为偏移单位。
（3）首部检验和：将所有首部，以16位为一个单位，全部进行反码算数运算（反码算数运算：当最高位产生进位，对求和结果+1）。

路由表：（目的网络，下一跳）

###### 分组转发算法

（1）从首部得到目的网络的IP地址；
（2）如果目的地址是路由器直连的网络，则直接交付，否则间接交付，执行（3）；
（3）如果路由表中目的地址是特定主机路由，则交付给特定主机路由，否则执行（4）；
（4）如果路由表中有到达目的网络的路由，则交付给此路由，否则（5）；
（5）若路由表中有一个默认路由，则交付给默认路由，否则（6）；
（6）报告转发分组出错。

##### （二）划分子网

**划分子网**：就相当于把原来一个网络，划分成几个独立的小网络，彼此独立，但均属于某一个网络，也就是对外仍是一个网络，对内相互独立。

从IP数据报本身，我们无法得知划分出的子网号，应该转发至哪一个子网，利用**子网掩码**可以实现寻找目的子网的操作。

###### 分组转发算法

（1）从首部得到目的网络的IP地址；
（2）先使用各个网络子网掩码与目的IP地址按位相与，如果目的地址是路由器直连的网络，则直接交付，否则间接交付，执行（3）；
（3）如果路由表中目的地址是特定主机路由，则交付给特定主机路由，否则执行（4）；
（4）使用各个网络子网掩码与目的IP地址按位相与，如果路由表中有到达目的网络的路由，则交付给此路由，否则（5）；
（5）若路由表中有一个默认路由，则交付给默认路由，否则（6）；
（6）报告转发分组出错。

##### （三）无分类编址CIDR（构造超网）

**特点**：
（1）不再区分A、B、C类网络以及划分子网的概念。使用“斜线记法”，由网络前缀和主机部分组成。
（2）将网络前缀相同的IP地址连成“**CIDR地址块**”。

###### 路由聚合

聚合条件：
（1）几个地址块具有相同的前缀；
（2）聚合后的地址包含聚合前几个地址块所有的IP地址。

聚合完成后的地址块属于一个表项。

###### 最长前缀匹配

当一个IP地址与多个路由表项匹配时，选择具有最长网络前缀的表项进行匹配。

# 网际控制报文协议ICMP

ICMP报文包含在IP数据报部分，允许主机或路由器报告差错情况和提供差错情况有关报告。

# 路由选择协议

路由器的任务是**转发分组**，分为两个结构，分别是路由选择和分组转发。

路由算法划分有两大类：静态路由选择和动态路由选择算法。

目前互联网主要采用的是：自适应（动态）的、分布式的路由选择算法。

将互联网划分为很多小的**自治系统**（Autonomous System AS），每一个AS使用单一技术进行管理的一组路由器，组内路由器使用一种自治系统的内部的路由选择协议和度量。一个AS对其它AS表现的是一个单一的和一致的路由选择协议。

目前互联网中路由选择协议分为两大类：
（1）**内部网关协议（Interior Gateway Protocol IGP）**（域内路由选择），即一个自治系统内部所使用的的路由选择协议，与其他自治系统无关，**使用最多**，如RIP协议、OSPF协议。
（2）**外部网关协议（Exterior Gateway Protocol EGP）**（域间路由选择），用于源主机和目的主机不在同一个系统中。目前使用的的是BGP协议。

#### 内部网关协议RIP

**RIP（Routing Information Protocol）路由信息协议**是一种基于距离的路由选择协议，最大优点是简单、开销小，用于小型的互联网。

从路由器到直连的网络的距离定义为1，而到非直连网络距离等于路由器数+1，允许一条链路上路由器最大数目为15，也就是距离最大为16，超过认为不可达。

RIP 协议仅选择一条具有最少路由的路径，哪怕另一条更高速但路由数较多。

**特点**：
1、仅和相邻的路由器交换信息。
2、交换信息是当前本路由器已经得到的路由表。
3、按固定时间间隔更新路由表。

##### 距离向量算法

交换和更新信息时，使用的算法是**距离向量算法**：
（1）对于地址X的相邻路由器发来的报文，先将所有下一跳地址改为X，并把所有距离都+1，每一个报文含有多个数据项，每个数据项包含：目的网络，距离，下一跳路由器地址X。
（2）a.如果原路由表中没有目的网络，直接加入此项。
b.如果目的地址相同，原路由表下一跳地址与报文中相同且距离不同，更新路由表报文。
c.如果目的地址相同，原路由表下一跳地址与报文中不同，保留距离较小的报文内容。
（3）如果3分钟没有收到相邻路由表的更新表，则把此相邻表记为不可达。

##### 好消息传播快，坏消息传播慢

“好消息”指的是路由表的更新很快，能够在较短的时间进行更新。
“坏消息”指的是当某一个路由器突然无法使用时，原来其它路由器的路由表无法及时收到这个消息，只有当路径距离增大到16时，才将其标为无法到达。

#### 内部网关协议OSPF

**OSPF Open Shortest Path First 开放最短路径优先**，**开放**指的是协议不收某一个厂商控制，而是公开发表的。**最短路径优先**指的是使用了迪杰斯特拉的最短路径优先算法，但不代表其他方法不是最短路径优先的，优点是更新收敛快。

最主要特征是：**链路状态协议**。

**特点**：
（1）向本自治系统中所有路由器发送信息。使用**洪泛法**，也就是向路由器所有输出接口发送，再有相邻的路由器继续向外发送。
（2）发送信息就是与本路由器相邻的所有路由器的**链路状态**，可以是很多信息，包含本路由器相邻的路由器及度量（不只是距离，也可以是费用、时延等代价）。
（3）只有链路状态发生变化时，路由器才会使用洪泛法发送信息。

与RIP协议相比，使用OSPF协议可以使路由器建立一个链路状态数据库，得出**全网的拓扑结构**，而且OSPF更新过程收敛得快，而RIP协议不行。

OSPF协议中，洪泛需要非常大的开销，所以使用划分区域，从而减小洪泛的范围，但划分的区域不能太大，区域内路由器数最好不超过200个。
如图所示，R3、R4、R7叫做区域边界路由器，主干区域内的叫主干路由器，连接其它自治系统的路由器叫自治系统边界路由器。各个区域内各自使用OSPF协议，各个区域之间再使用OSPF协议，这样可以实现层次结构的区域划分。

OSPF不使用UDP而是直接使用IP数据报，因为其构成的数据报很短，这样可以减少路由的通信量。

其他特点：
（1）OSPF 允许管理员给不同路指派不同的代价，对不同业务可以计算出不同的路由。
（2）如果到达同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。**（负载平衡）**
（3）所有在OSPF路由器之间交换的分组，都具有鉴别功能，保证了仅在可信赖的路由器之间交换链路状态信息。
（4）OSPF支持了可变长子网划分和CIDR。
（5）由于网络链路经常变化，OSPF给每一个状态都带上一个32位序号，序号越大，更新越快。

**OSPF分组类型（5）**：

分别是：问候、数据库描述、链路状态请求、链路状态更新、链路状态确认。

OSPF规定，相邻的两个路由器每隔10s就要交换问候分组，确认哪些路由器是可达的。当不可达时，立即修改链路状态数据库，并重新计算路由表。

当一个路由器链路发生变化，该路由器使用链路状态更新，使用洪泛法向全网更新链路状态。OSPF使用的是可靠的洪泛法，即需要确认。

#### 外部网关协议BGP

为什么不用RIP或OSPF？
1、互联网规模很大，AS自治系统之间相互选择很困难；
2、AS之间的路由选择必须考虑有关策略。即有时需要的不只是最短路或者最小代价，而是更复杂的综合性问题。

**BGP Border Gateway Protocol** 边界网关协议，并非是要找到一条最佳路由，而是找到一条能够到达目的网络的较好的路径。每一个自治系统至少选择一个“**BGP发言人**”，一般两个BGP发言人由至少由一个共享网络连接。一个发言人要与其它自治系统AS的发言人交换路由信息，建立TCP连接，交换BGP报文，建立BGP会话，此时建立TCP连接的两个发言人可以成为对等站（邻站）。

BGP协议交换的网络可达性，就是要到达某个网络需要经过的自治系统AS。并且在发言人内的自治系统连通图是树形结构的，不存在回路。

# IPv6

IPv4地址无法满足使用需要，采用IPv6，每个地址16字节。

IPv6特点有：
1、更大的地址空间；2、扩展的地址层次结构；3、灵活的首部格式；4、改进的选项；5、允许协议继续扩充；6、支持即插即用；7、支持资源的预分配。

**冒号十六进制记法**：

使用十六进制，每个冒号分割一个4位的十六进制数，连续的0可以用“：：”简写，但是一个地址只能使用一次。

全0地址只能当源地址使用，不能用做目的地址。
环回地址为：：1。
多播地址占1/256。
本地连读单播地址占1/1024。

# VPN虚拟专用网和NAT网络地址转换

**VPN Virtual Private Network 虚拟专用网**，这种网络是为本机构的主机用于机构内部的通信，而不是用于和网络外非本机构的主机通信。知只是在效果上和真正的专用网一样。

虚拟专用网连接的场所，每个场所中至少有一个路由器具有合法的全球IP地址。在互联网的发送过程会加密。

**NAT Network Adress Translation 网络地址转换**，使用装有NAT软件的路由器实现，其至少有一个有效的外部全球IP地址。
当NAT路由器具有n个全球IP地址时，专用网内最多可以同时有n台主机。
带端口号的NAT也叫NAPT。

# 多协议标记交换MPLS

**MPLS MultiProtocol Label Switching 多协议标记交换**，利用面向连接技术，使每个分组携带一个标记，当分组到达交换机，交换机读取标记，并根据标记进行分组转发。

1、支持面向连接的服务；
2、支持流量工程，平衡网络负载；
3、有效支持虚拟专用网VPN。