[toc]

# 计算机调度简介

## 为什么需要研究计算机调度？

一般来说计算机会同时处理多个请求，但是**资源是有限的，调度就是用来协调请求对资源的使用的方法**。

## 计算机是如何进行调度的？

一般调度器会通过**维护运行队列的方式**来管理任务。例如Linux会用红黑树来实现运行队列。任务在执行时若触发一定条件，则会停止执行，如果还需要执行，会被重新加入运行队列。

调度器的决策包括：

- 从运行队列选择下一个运行的任务

- 决定执行该任务的CPU核心
- 决定该任务被允许执行的时间（时间片）

决策完成后系统中的相应机制便会将任务执行在对应的CPU核心上。

## 计算机调度应该达到什么样的效果？

常用的调度指标有：

性能指标

- 吞吐量

  单位时间内处理的任务数量

- 周转时间

  任务从被发起直至执行结束所需要的时间

- 响应时间

  任务从发起知道第一次向用户返回输出以相应用户所需时间

非性能指标

- 公平性
- 资源利用率

特殊需求

- 实时性
- 能耗

任务所需的调度指标：

- **批处理任务**如机器学习的训练、复杂的科学计算，无需与用户交互，尽可能快的完成，需要：**吞吐量尽可能高，周转时间尽可能短**。
- **交互式任务**如程序调试，希望**响应时间足够短**。
- 有截至时间要求的**实时任务**如车载系统中的自动刹车，要求实时任务在截止时间前完成**满足实时性**。
- 移动设备有**待机时间**的要求，即移动设备上的操作系统调度要尽可能**降低能耗**。

## 设计实现计算机调度有何困难？

- 调度指标多样性

  不同任务的调度指标选取不一样，**切换应用场景时，旧的调度器不能适应新场景**

- 调度可参考的信息有限

  应用场景动态变化，调度器**只能通过有限的信息做出调度决策**

- 任务间的复杂交互

  同一程序的任务间可能有相互关联的逻辑，需要相互依赖，调度器**不能独立地调度这些任务**

- 许多方面存在权衡

  - 调度开销与调度效果

    调度器需要做出合理决策，需要统筹足够多的信息，进行运算，**导致决策时间变长**

  - 优先级与公平性

    一方面保证**高优先级任务优先执行**，另一方面**不能让低优先级的任务执行的时间过短**甚至无法执行。

  - 性能与能耗

    调度器过分追求性能，总是让CPU维持高速运转，导致**单位时间能耗过高**。

# 调度机制

## 任务是如何在计算机系统中被调度的？

调度机制对任务在不同状态（新生，就绪，运行，阻塞）状态之间转换。

## 长期、中期、短期调度的具体职责是？

### 长期调度

触发间隔较长，粗粒度地决定是否应该将一个新的进程纳入调度管理，负责增加系统中可被调度的进程的数量。

长期调度限制系统中真正被短期调度管理的进程数量，避免短期调度的开销过大。决定了当前可被调度进程的数量。

### 短期调度

触发最为频繁，负责细粒度地调度进程执行，做出相应的调度决策。

实际做出调度决策的是短期调度，负责进程在就绪，运行，阻塞状态的转换。短期调度要尽可能满足调度指标，处于就绪状态的进程需要被短期调度允许才能运行。而处于运行状态的进程可能会被短期调度打断。

### 中期调度

触发相对频繁，辅助换页机制，限制系统中可被调度的进程数量。

中期调度将内存使用情况也纳入考量，避免内存使用过多，实际上是换页机制的一部分。如果当前系统中的进程已经占用了大量内存，中期调度会挂起系统中被短期调度管理的进程。

中期调度会根据某些策略选择要挂起的进程（频繁触发缺页异常，长时间未响应），该进程会被设置为对应的挂起状态，换页机制会倾向于选择被挂起的进程所使用的内存页换入磁盘。中期调度也会监控内存使用情况，在适当的时机激活此前挂起的进程，使得其可以被重新调度。

# 单核调度策略

## 单核场景有哪些调度策略？不同的单核调度策略的优点和缺点是什么？

### 经典调度策略

#### FCFS FIFO

FCFS策略选取第一个任务，移出队列并执行，执行完毕后再次放入运行队列队尾。简单直观不需要预知任务信息和手动调试参数。

弊端：长短任务混合场景下对短任务不友好（长任务排在短任务前使得周转时间变长）。对I/O密集型任务不友好（I/O请求完成后还需要等待其他任务）。

#### SJF 最短任务优先

FCFS的短任务等待时间过长产生了一种新的策略SJF，即选择运行时间最短的任务执行。

##### 弊端

必须预知任务的运行时间（系统很难预知将要处理的任务确切的运行时间）。表现严重依赖任务到达时间点（短任务比长任务后到）。

#### STCF 最短完成时间任务优先

迟到任务无法受益于SJF，所以可以让调度器去调度迟到的短任务，即抢占版本的SJF策略STCF。

##### 弊端

长任务饥饿（大量短任务和少量长任务，长任务可能会无法占用CPU资源）

#### RR 时间片轮转

为了定时响应用户，为任务设置时间片，限定任务每次执行时间。当前任务执行完时间片后，就切换到运行队列中的下一个任务。（有切换开销，过小时间片引入大量开销，时间片过长产生和FCFS策略相同的负面效果）

##### 弊端

在任务运行时间相似的场景下平均周转时间高。

### 优先级调度

为了让操作系统可以区分交互式任务和批处理任务，可以设置一个让交互式任务优先执行的调度策略。引入优先级概念。

#### MLQ 多级队列

每个任务会被分配预先设置好的优先级，每个优先级对应一个队列，任务会被储存在对应的优先级队列中。如果优先级不同的任务同时处于就绪状态，那么调度器倾向于调度优先级较高的任务。同优先级的任务采用FCFS（可以被更高优先级抢占）或RR策略。

一般会让I/O密集型任务优先级提高（对CPU资源消耗较少），充分利用空闲的I/O资源。

弊端：低优先级任务饥饿（低优先级任务一直等待执行）。优先级反转（低优先级任务的锁无法被高优先级打开导致高优先级任务无法执行，解决方案是优先级继承，将自己的优先级转让给有锁任务）

#### MLFQ 多级反馈队列

MLFQ在早期的Linux、Windows和MacOS中都有应用。

##### 短任务拥有更高的优先级

- 优先调度短任务可以有更好的平均周转时间。
- I/O密集型任务一般在CPU中执行时间很短，提高短任务优先级相当于提高I/O密集型任务的优先级，有利于提高系统的I/O资源利用率
- 交互式任务一般是短任务，提高其优先级

统计每个任务已经执行了多少时间，并据此判断该任务是短任务还是长任务。

MLFQ会为每个任务队列设置任务的**最大运行时间**（任务最多运行总时间，不是时间片），长任务会随着执行次数增多优先级降低。

##### 低优先级任务采用更长的时间片

MLFQ支持抢占式调度，无需担心低优先级任务阻塞新进入系统的任务。

##### 定时地将所有任务优先级提至最高

为了防止低优先级任务饥饿，在一定的时间周期后将系统所有任务的优先级重新提升至最高级，保证不会有任务饥饿。

#### 弊端

MLFQ的具体实现中，需要调整很多调度参数：优先级队列数量、每个优先级队列采用时间片、任务在每个优先级队列的最大运行时间、调度器定时提升优先级的时间间隔。

- 提升优先级的时间间隔过短可能会让MLFQ退化成RR
- 提升优先级的时间间隔过长可能会导致长任务保持在最低优先级队列中

### 公平共享调度

我们会发现，优先级的数值仅用于比较优先级高低存在，不能反应单位时间内一个任务可以占用的CPU时间比例。

共享调度会量化每个任务对系统资源的占用比例，从而实现对资源的公平调度。我们将以**份额（share）**来量化每个任务对CPU时间的使用。

#### 彩票调度

彩票对应于份额，在该策略中，会根据随机数确定任务是否会被调度。任务份额越大，随机数就越可能落在它的份额内，因此就越有可能被调度。随着调度次数增加，任务被调度的次数占总调度次数的比例也将趋于所拥有份额占总份额比例。

伪代码：

```python
R = random(0, total_tickets)
sum = 0
foreach(task in task_list) {
    sum += task->ticket
    if (R < sum) {
        schedule()
        break
    }
}
```

彩票调度不要求列表中任务按照持有彩票的数量排序，因为影响任务被调度的概率是持有的份额而非列表中顺序，但是按彩票数量排序可以减少查找次数。

##### 彩票转让

份额大的任务A可能在等份额小的任务B的锁，彩票转让使得A可以将自己的份额转让给B，转让后，任务B有更高的CPU占比份额。类似优先级继承。

##### 彩票货币

用户或任务组在分配自己的彩票给子任务时，可以采用自己的计算方式发行内部的货币。这样如果任务组的彩票总数减少了，对应的内部货币不需要修改。让任务组可以灵活修改持有的份额。

##### 彩票通胀

允许任务根据当前对CPU资源的需求决定自己的份额。可以应对变化的应用场景，让需要资源的任务动态申请更多的资源，不需要资源的任务可以自己释放资源。但是如果有任务恶意提升才漂亮，那么最坏情况下会占用绝大部分CPU时间。

##### 弊端



#### 步幅调度



### 实时调度

#### 速率单调



#### 最早截止时间优先



### 其他调度

#### 借用虚拟时间



# 多核调度策略

## 在多核场景下有哪些调度策略？这些调度策略的优点与缺点分别是什么？



## 多核调度如何考虑负载均衡？



## 多和调度如何考虑能耗？



# 调度进阶机制

## 如何指定执行任务的CPU核心，提高数据处理的局部性？



## 如何设置与统一当前操作系统上的不同调度策略？



