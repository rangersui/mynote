[toc]

# 什么是操作系统

操作系统的职责：

- 对硬件管理和抽象
- 对应用提供服务并进行管理

狭义的操作系统是操作系统内核加上一个Shell。

## 操作系统必要性

- 如果没有操作系统应用直接和硬件打交道，缺少硬件资源管理和抽象功能，若是出现故障，可能引起直接崩溃，没有诊断和调试机会。但如果实现一个外部库对硬件资源抽象，故障恢复和调试问题，即实现一个基于**外核（Exokernel）**架构的**库操作系统（LibOS）**或是**虚拟化容器**等方法，适用于对性能和时延要求极高的场景。
- 如果一个应用希望直接控制硬件，依然还是需要操作系统的，因为应用加载与销毁，多个应用切换与隔离需要操作系统完成，并且操作系统可以从全局角度合理调度，高效利用硬件。

正是因为以上的管理能力，一个无限循环的打印程序不会卡死计算机，因为操作系统会对硬件资源按照优先级在不同硬件进行调度。但是fork炸弹依旧可以卡死计算机，但操作系统提供了给应用的资源设置配额的机制，限制一个应用能用的资源数量。

## 操作系统接口

从应用角度来看，操作系统提供了不同层次的接口。

### 系统调用接口

系统调用是**用户态应用**向**操作系统内核**请求服务的方法。

以printf为例，printf函数调用标准库libc的write函数，libc准备好相关参数后执行svc指令（ARM指令的特权调用 supervisor call）使得控制流从用户地址空间下陷到内核地址空间。操作系统内核下陷处理函数根据系统调用传入的第一个参数，识别出调用需要执行操作系统内核提供的sys_write函数，从系统调用表调用对应的函数。

### POSIX接口

为了同一个应用程序在不同操作系统上的可移植性形成了一些可移植操作系统接口标准，如POSIX。全称Portable Operating System Interface for Unix，可移植操作系统接口。这个标准通常通过C library实现，通常而言应用程序只需要调用libc接口就可以实现对操作系统功能的调用，并应用在类Unix系统上。

### 领域应用接口

POSIX或操作系统调用的基础乡可以封装面向不同领域的应用接口。为了开发的便捷性（复用功能），人们开始为各个应用领域定义应用开发接口与软件架构。例如安卓和苹果手机的应用开发接口。

## 本书的实验操作系统

chCore采用了微内核架构设计理念，大部分系统功能以系统服务的形式运行在用户态，与Linux和Windows为代表的宏内核形成对比。这样设计的优势是用户态的系统奔溃或安全漏洞不影响到操作系统的其他功能组件如内存管理，设备驱动等；提升了操作系统安全性和可靠性。

chCore包括两个部分：

- 运行在内核态的chCore微内核
- 运行在用户态的各种操作系统服务

