[toc]

一个操作系统需要满足一定的设计目标，可以分为以下两种：

- 用户目标：方便使用，易于学习，可靠，安全以及流畅
- 系统目标：易于实现和维护，灵活，可靠，不易出错，高效

# 操作系统的机制与策略

## 如何控制操作系统的复杂度？

将策略和机制分离。

## 什么是机制？什么是策略？为什么要将二者尽可能分离？

策略（policy）是做什么，机制（mechanism）代表如何做。

|      | 策略                     | 机制                                           |
| ---- | ------------------------ | ---------------------------------------------- |
| 登录 | 什么用户，以什么权限登录 | 输入处理，策略文件管理，桌面启动加载           |
| 调度 | 先到先得服务，时间片轮转 | 调度队列的设计，调度实体的表示，调度的中断处理 |

通过将这两者分离，可以通过不同策略来适应不同应用需求，持续优化机制来完善策略的实现。

同样的机制可以实现多种不同的策略，所以改变策略并不一定需要改变机制，只需要改变一些参数。

而机制的改变可以使得它更高效，或者实现平台的迁移，而不需要改变总体策略。

# 操作系统复杂度管理方法

## 什么是M.A.L.H方法？

- 模块化 modularity

  分而治之（divide and conquer）原则，将一个复杂系统分解为一系列通过明确定义的接口进行交互的模块，并严格保障模块之间的界限。划分模块要做到“高内聚，低耦合”

- 抽象 abstraction

  这是在模块化的基础上，将接口和内部实现分离，从而使得模块之间通过抽象的接口互相调用，无需关心各个模块的内部实现。就比如UNIX系列操作系统提供虚拟内存作为物理内存的抽象，文件系统使得应用程序不需要关心物理介质而是通过系统接口访问。

- 分层 layering

- 层级 hierarchy

## 分层和层级有哪些区别？

为了避免模块之间的过多交互，需要通过分层和分级降低复杂度。

- 分层 layering

  将模块按一定原则进行层次划分，约束每层内部模块间的交互方式和跨层次模块的交互方式。一般来讲：一个模块只能和同层模块以及上层或下层模块交互，不能跨层交互。

- 层级 hierarchy

  将功能相近的模块组成一个具有清晰接口的自包含子系统，再将这些子系统递归地组成一个具有清晰接口的更大子系统。

分层是不同类模块之间的层级，层级则是同类模块的分层，两种方法是可以组合的。

# 操作系统内核架构

## 内核有哪些常见的架构？

- 简要架构

  App和内核都运行在内核态，将应用程序和操作系统放在同一地址空间，无需底层硬件提供复杂的内存管理，特权级隔离等功能。虽然缺乏隔离功能，但是简要结构的操作系统依然采用了一定的模块化与层次结构以降低复杂度。

- 宏内核

  也被称为单内核，特征是所有模块（进程调度，内存管理，文件系统，设备驱动）运行在内核态，具备直接操作硬件的能力。

- 微内核

  对宏内核架构的操作系统进行解耦合，将单个功能或模块（文件系统，设备驱动等）从内核中拆分出来，作为一个独立的服务部署到独立的运行环境中；内核只保留极少的功能，为这些服务提供通信等基础能力。微内核架构下，服务和服务是完全隔离的，单个服务故障或被攻击不引起整个操作系统奔溃或被攻破。

- 外核

  在许多场景中，应用比操作系统更了解该如何去抽象和使用硬件资源。提出库操作系统（LibOS）概念，将对硬件的抽象封装到LibOS中，与应用直接链接，降低应用开发复杂度；而操作系统内核则只负责对硬件资源在多个库操作系统之间的多路复用的支持，并管理这些LibOS的生命周期。

  外核可以根据应用需求提供定制化的高效资源管理，抽象为一系列的LibOS。对于性能和时延敏感的嵌入式场景，通过LibOS运行应用业务使得数据面（数据处理与转发）和控制面（设备配置和管理）分离；但是LibOS通常为某种应用定制，缺乏跨场景通用性，应用生态差。

- 多内核

  基于硬件的众核与异构特性，Multikernel将一个众核（多于8个处理器核）系统看成一个由多个独立处理器核通过网络互连而成的分布式系统；它仍然假设硬件处理器提供全局共享内存的语义，但是对于不同处理器核之间的交互，提供了一层基于进程间通信的抽象，避免了处理器核之间通过共享内存进行隐式的共享。每个CPU核上运行一个独立的操作系统节点，节点间交互通过进程间通信完成。

- 混合内核

  Linux内核是公认的宏内核，但是近期开始融合微内核架构中的用户态驱动模型（UIO与VFIO等）。又比如苹果操作系统内核XNU是一个Mach微内核与BSD UNIX的混合体。

## DOS的架构有什么优点和缺点？

优势在于，应用程序对操作系统的调用可直接通过函数调用完成

缺点是，任何一个应用或操作系统模块出现问题都可能会让整个系统奔溃。

## 一个应用是否能运行在多个内核之上？

多内核架构可以，上层应用通过Multikernel提供的进程间通信接口进行交互。

## 微内核和宏内核孰优孰劣？

- 弹性扩展能力：对于宏内核来说，很难通过简单的裁剪或扩展，使其支持资源诉求从KB到TB级别的场景

- 硬件异构性：异构硬件往往需要一些定制化的方式来解决特定问题，这种定制化对宏内核来说很难得到长期的支持

- 功能安全：宏内核在故障隔离和时延控制方面的缺陷，尚无通过高等级功能安全认证

- 信息安全：宏内核存在较大的信息安全隐患，如内核态驱动容易导致低质量的驱动代码入侵内核，粗粒度权限管理容易带来权限漏洞

- 确定性时延：由于宏内核架构资源隔离较为困难，各模块耦合度过高导致难以控制系统调用的时延，因此较难做到确定性时延；即便为时延做一些特定优化时延抖动依然很大。

# 操作系统框架结构

## 为什么说Android的系统框架与微内核相似？

Android在linux内核上提供了一层硬件抽象层，封装了一些硬件实现细节，实现内核和系统框架的解耦；通过提供用户态驱动模型，使得厂商可以绕开GPL协议。

安卓系统框架的设计整体应用了类似微内核架构的思想，将系统框架组件化与服务化，各个组件依赖于Android提供的Binder IPC（进程间通信）进行通信。

## Android称为最流行的移动终端操作系统，这与它的结构有哪些关系？

- 硬件抽象层
- Android库
- Android运行环境（ART）
- Android应用框架

# 思考题

## 微内核和外核的主要区别是？有哪些优势和劣势？

区别：

- 外核架构将多个硬件资源切分为一个个切片，每个切片中保护的多个硬件资源由LibOS管理并直接服务于一个应用；微内核架构则是通过让一个操作系统模块独立运行在一个地址空间上来管理具体的硬件资源，为操作系统的所有的应用服务。
- 外核架构中，运行在特权级的内核主要是为LibOS提供硬件的多路复用能力并管理LibOS；微内核架构中，内核主要提供进程间通信（IPC）功能。

优势劣势：

- 外核架构在面向一个功能与生态首先的场景时可以通过定制LibOS获得非常高的性能；微内核架构需要复杂的优化才能获得与之类似的性能
- 外核架构难以移植，一般是为某个应用定制的，缺乏跨场景的通用性。此外，LibOS通常会实现相同或类似的功能，容易造成代码冗余，因此对资源受限场景，还需要一些跨地址空间的代码去重或共享机制来减少内存开销。

## 以下哪些是机制哪些是策略？

- 先进先出换页
- O(1)调度队列
- 基于B+树的文件结构

机制：O(1)调度队列和基于B+树的文件结构

策略：先进先出换页

## 关于操作系统中机制与策略分离，还能想到什么例子？



## 微内核性能一定差吗？瓶颈在哪里？



## 如果一台计算机中有不同的ISA（指令集架构）的CPU，操作系统应该采用哪种架构？能想到更好的架构吗？

多内核架构
